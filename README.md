# Blockchain API Service

Простой сервис для работы с блокчейном Ethereum и Avalanche. Позволяет узнать баланс кошелька на конкретном блоке и получить события из смарт-контракта.

## Возникшие проблемы, которые решать как будто бы слишком проблематично
При запросе слишком большого пласта данных, например
{
  "from_block": 1,
  "contract_address": "0x66357dCaCe80431aee0A7507e2E361B7e2402370",
  "network": "avalanche"
}
Оно возвращает свыше 500к ивентов, из-за чего память браузера сжирается и крашится. Та же беда и с тем, что запрос вероятно уйдет в таймаут при ожидании.

## Моменты для улучшения
В таске не было описания требований по оптимизации, поэтому из подобных решений я ввёл лишь кэширование через редиску. Однако конечно, т.к. тот же 0x66357dCaCe80431aee0A7507e2E361B7e2402370 парсить с 3летней давности до текущего момента - это очень долго и жирно по затратам оперативы, то было бы славно подкрутить полноценную базу данных, где хранились бы эти ивенты и информация о том, какие блоки уже были получены. Но это уже другая история :)

Также из интересных решений можно было бы 



## Что умеет

### 1. Проверка баланса кошелька
Показывает сколько было денег на кошельке на момент конкретного блока. Работает как для Ethereum, так и для Avalanche.

### 2. Получение событий контракта
Выдает все события, которые произошли в смарт-контракте, начиная с указанного блока до текущего момента.

Огромное количество блоков постарался оптимизировать батч обработкой + гиперпрыжками по миллионам пустых блоков в случае отсутствия ивентов (дабы собственно скипать года без ивентов)

## Как запустить

### Через Docker (рекомендуется)

Создай файл `.env` с данными как в .env.example (API ключи требуется получить у провайдеров)
И запусти:
```bash
docker compose up -d
```

Всё. Сервис на `http://localhost:8000`, Redis тоже поднимется автоматически.

### Локально без Docker

Если хочешь запустить без контейнеров:

1. Поставь зависимости (нужен Python 3.12):
```bash
poetry install
```

2. Подними Redis отдельно и создай `.env`.

3. Запусти:
```bash
poetry run uvicorn main:app --reload
```

## Как пользоваться

После запуска открой `http://localhost:8000/docs` — там интерактивная документация со всеми примерами.

### Пример 1: Узнать баланс кошелька

```bash
curl -X POST "http://localhost:8000/api/blockchain/balance" \
  -H "Content-Type: application/json" \
  -d '{
    "wallet_address": "0x1234567890123456789012345678901234567890",
    "block_number": 12345678,
    "network": "avalanche"
  }'
```

Ответ:
```json
{
  "wallet_address": "0x1234567890123456789012345678901234567890",
  "block_number": 12345678,
  "balance_wei": 1000000000000000000,
  "balance_eth": 1.0,
  "network": "avalanche"
}
```

### Пример 2: Получить события контракта

```bash
curl -X POST "http://localhost:8000/api/blockchain/events" \
  -H "Content-Type: application/json" \
  -d '{
    "from_block": 12345678,
    "contract_address": "0x66357dCaCe80431aee0A7507e2E361B7e2402370",
    "network": "avalanche"
  }'
```

## Технологии

- **FastAPI** — веб-фреймворк
- **Web3.py** — для работы с блокчейном
- **Pydantic** — валидация данных
- **Dishka** — dependency injection
- **Redis** — кеширование
- **Docker** — контейнеризация
- **Pytest** — тесты

## Тесты

Запустить тесты:
```bash
poetry run pytest
```

Тесты проверяют оба эндпоинта и обработку ошибок.

## Поддерживаемые сети

- **Avalanche** (по умолчанию)
- **Ethereum**

RPC endpoints:
- Ethereum: `https://rpc.ankr.com/eth`
- Avalanche: `https://rpc.ankr.com/avalanche`

## Дополнительно

- Кеширование результатов в Redis для быстрых повторных запросов
- Автоматическое получение и кеширование ABI контрактов
- Обработка ошибок и валидация адресов
- Swagger документация из коробки

## Healthcheck

Проверить что сервис живой:
```bash
curl http://localhost:8000/health
```

Ответ: `{"status": "healthy but depressed", "version": "1.3.3.7"}`
